---
- include_role:
    name: dp_docker
  vars:
    version: "{{ dp_version }}"

# Set up
- name: Delete the foo domain
  community.datapower.config:
    domain: default
    state: absent
    config:
      Domain:
        name: foo

- name: Create the foo domain
  community.datapower.config:
    domain: default
    state: present
    config:
      Domain:
        name: foo

- name: create demo.txt at local
  community.datapower.files:
    domain: foo
    src: "{{ role_path }}/files/demo.txt"
    dest: local/demo.txt
    state: present
  register: create_result

- name: Validate create demo.txt at local
  assert:
    that:
      - "{{ create_result['changed'] == True }}"
      - "{{ create_result['response']['result'] == 'File was created.' }}"

- name: Get a temporary directory to download demo.txt into
  ansible.builtin.tempfile:
    state: directory
  register: tempdir

- name: fetch /local/demo.txt in check mode
  community.datapower.fetch_file:
    domain: foo
    src: /local/demo.txt
    dest: "{{tempdir.path}}"
  register: update_result
  check_mode: true

- name: Grab stats for previous fetch in check mode
  stat:
    path: "{{update_result.path}}"
  register: fetched_stat

- name: Validate check mode did not create the file
  assert:
    that:
      - fetched_stat.stat.exists == False

- name: fetch /local/demo.txt for real this time.
  community.datapower.fetch_file:
    domain: foo
    src: /local/demo.txt
    dest: "{{tempdir.path}}"
  register: update_result

- name: Grab stats for previous fetch
  stat:
    path: "{{update_result.path}}"
  register: fetched_stat

- name: Validate /local/demo.txt exists
  assert:
    that:
      - fetched_stat.stat.exists

- name: fetch /local/demo.txt again for idempotency check
  community.datapower.fetch_file:
    domain: foo
    src: /local/demo.txt
    dest: "{{tempdir.path}}"
  register: update_result

- name: Validate idempotency
  assert:
    that:
      - update_result.changed == False